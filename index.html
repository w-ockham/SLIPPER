<!DOCTYPE html>
<html>
 <meta http-equiv='cache-control' content='no-cache'>
<meta http-equiv='expires' content='0'>
<meta http-equiv='pragma' content='no-cache'>
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-139463065-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-139463065-1');
</script> 
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="shortcut icon" href="favicon.ico">
<title>SOTAwatch Live!</title>
<style>
.jumbotron-extend {
    position: relative;
    height: 40vh;
    min-height: 220px;
};
i.semantic-ui-custom {
  margin-top: 9px;
}
</style>
</head>
<body>
<div class="header clearfix">
    <h3 class="text-muted">&nbsp SOTAwatch Live! &nbsp&nbsp <small><span id="clock_time"></small></span>
</div></h3>
<div id="map" class="jumbotron jumbotron-extend" style="padding-bottom:15px;margin-bottom:13px">
</div>
<div id="qrvinfo" class="container bg-light" style="height:50vh;overflow:auto;border:1px solid #aaa;padding:5px;-webkit-overflow-scrolling:touch">	
</div>

<div id="select" class="container" style="padding-top:4px">
    <div class="form-inline align-items-center justify-content-center">
    <div class="form-group">
    <label for="custom-select-time"><b>For last:</b>&nbsp</label>
    <select id="select-time" class="custom-select custom-select-sm" style="width:auto;">
    <option value="6">4H+Alerts</option>
      <option value="30">30 hours</option>
    </select>
    </div>
    <div class="form-group">
    <label for="custom-select-area"><b>Within:</b>&nbsp</label>
    <select id="select-area" class="custom-select custom-select-sm" style="width:auto;">
    <option value="WW">WW</option>
    <option value="JA">JA</option>
    <option value="AS">AS/OC</option>
    <option value="EU">EU/AF</option>
    <option value="NA">NA/SA</option>
    </select>
    </div>
    <div class="form-group">
    &nbsp<button type="button" class="btn-info btn-sm ApplyButton" onClick="clickApplyButton">Apply</button>
    </div>
    </div>
</div>
    <footer class="page-footer font-small text-center" style="padding-top:5px">
</footer>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script
src="https://code.jquery.com/jquery-3.4.0.min.js"
integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<!-- plugin -->
    <link rel="stylesheet" href="css/leaflet.extra-markers.min.css" />
    <script src="js/leaflet.extra-markers.min.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.3.1/dist/semantic.min.css">
    <link rel="stylesheet" href="css/L.Icon.Pulse.css" />
    <script src="js/L.Icon.Pulse.js"></script>
    <!-- plugin -->

<style type="text/css">
    i.semantic-ui-custom {
        margin-top: 9px;
    }
</style>

<script>
$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})
function getParam(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

var map = L.map('map');
var area = getParam('area')
if (area == null &&  $.cookie('area') != "")
	area = $.cookie('area');

L.control.scale().addTo(map);

if (area!="JA") {
    var osm = L.tileLayer('https://tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey=767750c193e54ceeb3aee08d880bdb90',{
    attribution: "<a href='https://www.thunderforest.com/'>Thunderforest</a>"});
//    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
//    attribution: "<a href='https://osm.org/copyright'>OpenStreetMap</a> contributors",maxZoom:19});
 
    osm.addTo(map);
}else {

    var gsi = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
	attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
    });
    gsi.addTo(map);
}

function drawPoly(lg,data,ssid,cl,route) {
    po = [];
    tm = [];
    dt = [];
    sm = [];
    for (var i = 0, len = route.length; i < len; ++i) {
	po.push(route[i].latlng);
	tm.push(route[i].time);
	dt.push(route[i].dist);
	sm.push(route[i].summit);
    };
    L.polyline(po,{color: cl, wight:6}).addTo(lg);

    for (var i = 0, len = po.length; i < len; ++i)
	L.circleMarker(po[i],{color:"red", radius:4}).addTo(lg);
    if (po.length > 0 ) {
	if (ssid == 0) {
 	    options = {
		prefix: 'icon'
		,icon: 'user outline'
		,shape: 'star'
		,markerColor: 'orange'
		,extraClasses: 'semantic-ui-custom'
	    };
	} else {
 	    options = {
		prefix: 'icon'
		,icon: 'car'
		,shape: 'star'
		,markerColor: 'orange'
		,extraClasses: 'semantic-ui-custom'
	    };
	};	    
 	var marker = L.marker(po[po.length-1],
			      {icon: L.ExtraMarkers.icon(options)});
	dist = ' ('+dt[dt.length-1]+'m from '+sm[sm.length-1]+')'
	if (data.aprs_message != "") 
	    marker.bindPopup(tm[tm.length-1]+' '+data.op+dist+'<br>'+data.aprs_message).openPopup()
	else
	    marker.bindPopup(tm[tm.length-1]+' '+data.op +dist).openPopup();
	marker.addTo(lg);
    }
}
					    
function drawObj(lg,data) {
    options = {
        prefix: 'icon'
        ,icon: 'flag checkered'
        ,shape: 'circle'
        ,markerColor: 'yellow'
        ,extraClasses: 'semantic-ui-custom'
    };
    var marker = L.marker(data.summit_latlng,
			  {icon: L.ExtraMarkers.icon(options)});
    marker.bindPopup(data.summit + ' '+ data.summit_info +'<br>'
		     + data.alert_time+ ' ' + data.op + ' ' + data.alert_freq + '<br>')
    marker.addTo(lg);

    if (data.route[0].length >0)
	drawPoly(lg,data,0,"blue",data.route[0])
    if (data.route[1].length >0)
	drawPoly(lg,data,1,"blue",data.route[1])

//    if (data.route[0].length >0)
//	drawPoly(lg,data,0,"red",data.smoothed[0])
//    if (data.route[1].length >0)
//	drawPoly(lg,data,1,"red",data.smoothed[1])
    
    
    if (data.spot_time != "") {
	if (data.spot_color == "red")
	    interval = 1
	else if (data.spot_color == "orange")
	    interval = 4
	else if (data.spot_color == "normal")
	    interval = 8
	else interval = -1;

	var pulsingIcon;
	if (interval >0) 
	    pulsingIcon = L.icon.pulse({iconSize:[20,20],color:'red',heartbeat:interval})
	else
	    pulsingIcon = L.icon.pulse({iconSize:[20,20],color:'red',animate:false});
	var marker = L.marker(data.summit_latlng,{icon: pulsingIcon});
	marker.bindPopup(data.summit + '<br>'
			 + data.spot_time + ' ' + data.op + ' ' + data.spot_freq + ' ' + data.spot_mode + '<br>' + data.spot_comment).openPopup();
	marker.addTo(lg);
    }
};

function clickApplyButton(){
    const time_range = document.getElementById("select-time").value;
    const area = document.getElementById("select-area").value;
    $.cookie('area',area);
    $.cookie('range',time_range);
    window.location.href = 'https://www.sotalive.tk/'
};
$('.ApplyButton').on('click',function() { clickApplyButton();});

function clickSummitButton(event) {
    var p = event.target.eventParam;
    qrvdata = p.data;
    for (var i = 0, len = qrvdata.length; i< len; ++i) {
	if (p.op == qrvdata[i].op && p.summit == qrvdata[i].summit) {
	    map.setView(qrvdata[i].summit_latlng,15);
	    break;
     	};
    };
};

function clickAPRSButton (event) {
    var p = event.target.eventParam;
    qrvdata = p.data;
    for (var i = 0, len = qrvdata.length; i< len; ++i) {
	if (p.op == qrvdata[i].op && p.summit == qrvdata[i].summit) {
	    var r
	    if (qrvdata[i].route[0].length > 0) 
		r = qrvdata[i].route[0]
	    else
		r = qrvdata[i].route[1]
	    
	    dist = r[r.length - 1].dist;
	    if (dist < 1000)
		zm = 15
	    else if (dist <2000)
		zm = 14
	    else if (dist <5000)
		zm = 13
	    else if (dist <10000)
		zm = 12
	    else if (dist <20000)
		zm = 11
	    else if (dist <30000)
		zm = 10
	    else if (dist <60000)
		zm = 9
 	    else if (dist <100000)
		zm = 8
 	    else if (dist <200000)
		zm = 7
	    else if (dist <400000)
		zm = 6
	    else
		zm = 5
	  
	    map.setView(r[r.length - 1].latlng,zm);
	    break;
     	};
    };
};

function clock() {
    var now = new Date();
    var utc = now.toUTCString()

    document.getElementById("clock_time").innerHTML=utc.replace('GMT','')
}

function update() {
    $('#qrvinfo').html('');

    area = getParam('area')
    range = getParam('range')
    
    if (area == null &&  $.cookie('area') != "")
	area = $.cookie('area');
	
    if (range == null && $.cookie('range') != "") 
	range = $.cookie('range');

    sel_t = document.getElementById("select-time");
    sel_a = document.getElementById("select-area");

    if (range=="30") {
	postfix = '-hist.json';
	clearInterval(update_timer);
	sel_t.selectedIndex = 1;
	update_timer = null;
    }else{
	sel_t.selectedIndex = 0;
	if (update_timer == null) 
	    update_timer = setInterval(update,60000);
	postfix = '.json';
    }
    if (area == "JA" && range == "6")
	fname = 'spotsJA' + postfix
    else
	fname = 'spots' + postfix
    
    $.cookie('area', area);
    $.cookie('range', range);

    if (area == "WW")
	sel_a.selectedIndex = 0;
    else if (area == "JA")
	sel_a.selectedIndex = 1;
    else if (area == "AS")
	sel_a.selectedIndex = 2;
    else if (area == "EU")
	sel_a.selectedIndex = 3;
    else if (area == "NA")
	sel_a.selectedIndex = 4;

    $.getJSON("https://www.sotalive.tk/json/"+fname,{ts:new Date().getTime()},function(qrvdata) {
	if (lg != null) {
	    map.removeLayer(lg);
	    lg = L.layerGroup();
	} else
	    lg = L.layerGroup();
	map.addLayer(lg);
	current="before";
	qdata = [];
	for (var i = 0, len = qrvdata.length; i< len; ++i) {
	    cont = qrvdata[i].continent;
	    if (area != "WW") {
		if (area == "JA" && (cont != "AS" ||
				     (qrvdata[i].summit.indexOf('JA') == -1)))
		    continue;
		if (area == "AS" && (cont != "AS") && (cont != "OC"))
		    continue;
		if (area == "EU" && (cont != "EU") && (cont != "AF"))
		    continue;
		if (area == "NA" && (cont != "NA") && (cont != "SA"))
		    continue;
	    }
	    qdata.push(qrvdata[i]);
	    drawObj(lg,qrvdata[i]);
	    if (qrvdata[i].spot_time != "") {
		if (qrvdata[i].spot_color == "red")
		    color = 'text-danger'
		else if (qrvdata[i].spot_color == "orange")
		    color = 'text-warning'
		else if (qrvdata[i].spot_color == "normal")
		    color = 'text-primary'
		else
		    color = 'text-secondary'
		
    		spotstr ='<div class="'+
		    color+'"><strong>'+
		    qrvdata[i].spot_time + ' ' + qrvdata[i].spot_freq + ' '+
		    qrvdata[i].spot_mode + 
		    '</strong></div>' +
		    '<div class="text-muted">'+
		    qrvdata[i].spot_comment + '</div>';
	    }
	    else
		spotstr = '';

	    if (qrvdata[i].route[0].length > 0||qrvdata[i].route[1].length > 0) 
    		badge = ' <button id="abt_' +i + '" type="button" class="btn-warning btn-sm">APRS</button>'
	    else
    		badge = '';
	    
	    body = '<div class="media-body"> <h5 class="mt-0 mb-1">' +
		qrvdata[i].op +'</h5>'+
    		qrvdata[i].summit +' '+ qrvdata[i].summit_info + 
		' '+qrvdata[i].association +
		'<br>'+ '<div class="text-muted">'+
		qrvdata[i].alert_time + ' ' +
		qrvdata[i].alert_freq  + ' '+
		qrvdata[i].alert_comment + '</div>'+
		spotstr + '</div>';
	    button = '<div class="align-self-center ">'+badge +'&nbsp <button id="sbt_' + i + '" type="button" class="btn-info btn-sm">'+qrvdata[i].summit + '</button></div>';
	    if (current == "before" && qrvdata[i].spot_type=="after") {
		current = "after";
		idstr = 'id="current_data"';
		current_latlng = qrvdata[i].summit_latlng;
			    
	    } else if ( i == qrvdata.length && curent == "before") {
		idstr = 'id="current_data"';
		current_latlng = qrvdata[i].summit_latlng;
	    } else {
		idstr = '';
	    }
   	    $('#qrvinfo').append('<div class="media" '+idstr+'>' + body + button + '</div><hr/>');
	    
   	    var elm = document.getElementById("sbt_"+i);
   	    elm.addEventListener("click",clickSummitButton,false);
	    elm.eventParam = { data : qrvdata, op: qrvdata[i].op , summit: qrvdata[i].summit };
	    if (qrvdata[i].route[0].length > 0||qrvdata[i].route[1].length > 0) { 
   	    var elm = document.getElementById("abt_"+i);
   		elm.addEventListener("click",clickAPRSButton,false);
		elm.eventParam = { data : qrvdata, op: qrvdata[i].op , summit: qrvdata[i].summit };
	    };
	};
	if (first_draw && qdata.length > 0) {
	    d = document.getElementById("current_data");
	    if (d!=null) {
		d.scrollIntoView(true);
		map.setView(current_latlng,15);
	    } else
		map.setView(qdata[0].summit_latlng,15);
	    first_draw = false;
	} else if (qrvdata.length == 0){
	    map.setView([35.362853,138.730910],15);
	    $('#qrvinfo').append('<div class="media"><div class="media-body"> <h5 class="mt-0 mb-1"> No Data.</h5></div><hr/></div>');
	} else {
	    d = document.getElementById("current_data");
	    if (d!=null)
		d.scrollIntoView(true);
	};

    });
};
lg = null;
first_draw = true;
update_timer = null;
update();
clock();
setInterval(clock,1000);
</script>
</body>
</html>
